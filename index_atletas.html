<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nómina de Atletas - Control Voley</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Definiciones de color para Tailwind (solo si no usas tailwind.config.js) */
        :root {
            --voley-blue: #007bff; /* Azul Eléctrico */
            --voley-dark: #0056b3; /* Azul Marino/Oscuro */
        }
        .text-voley-blue { color: var(--voley-blue); }
        .bg-voley-blue { background-color: var(--voley-blue); }
        .hover\:bg-voley-dark:hover { background-color: var(--voley-dark); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <header class="bg-gray-800 text-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold">Control Voley</h1>
            <nav>
                <a href="#" class="px-3 py-2 rounded-md text-sm font-medium bg-voley-blue hover:bg-voley-dark transition">Nómina de Atletas</a>
                </nav>
        </div>
    </header>

    <main class="flex-grow p-6">
        <div class="max-w-7xl mx-auto">
            
            <div id="table-view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-800">Atletas Registrados (Nómina de Club)</h2>
                    <button onclick="navigateTo('form')" class="bg-voley-blue hover:bg-voley-dark text-white font-bold py-2 px-4 rounded-lg shadow-md transition">
                        + Registrar Nuevo Atleta
                    </button>
                </div>
                
                <div class="bg-white p-4 rounded-xl shadow-lg mb-6 flex justify-between items-center border border-gray-200">
                    <input type="text" id="searchInput" placeholder="Buscar por Nombre, Posición..." class="p-2 border border-gray-300 rounded-lg w-1/3">
                    <select id="sortSelect" onchange="loadAthletes()" class="p-2 border border-gray-300 rounded-lg">
                        <option value="nombre_asc">Ordenar por Nombre (A-Z)</option>
                        <option value="fechaNacimiento_desc">Ordenar por Edad (Menor)</option>
                        <option value="montoPago_desc">Ordenar por Salario (Mayor)</option>
                    </select>
                </div>

                <div class="shadow overflow-hidden border-b border-gray-200 sm:rounded-lg bg-white">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Nombre Completo
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Edad
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Métrica
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Salario
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Último Pago
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Estado
                                </th>
                                <th scope="col" class="relative px-6 py-3">
                                    <span class="sr-only">Acciones</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="athletesTableBody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="7" class="text-center py-4 text-gray-500" id="loadingMessage">Cargando datos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="form-edit-view" class="hidden">
                <section class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-2xl mx-auto border border-gray-200">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                         <h2 class="text-xl font-bold text-voley-blue" id="formTitle">Registro de Nuevo Atleta</h2>
                         <button onclick="navigateTo('table')" class="text-gray-500 hover:text-gray-700 transition font-medium">
                            ← Volver a la Nómina
                         </button>
                    </div>

                    <form id="athleteForm" onsubmit="handleFormSubmit(event)">

                        <input type="hidden" id="athleteId" value=""> 

                        <h3 class="font-semibold mt-4 mb-2 bg-voley-blue text-white p-2 rounded-md">1. Datos del Atleta</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre</label>
                                <input type="text" id="nombre" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="apellido" class="block text-sm font-medium text-gray-700">Apellido</label>
                                <input type="text" id="apellido" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="fechaNacimiento" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label>
                                <input type="date" id="fechaNacimiento" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                                <input type="tel" id="telefono" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                        </div>

                        <h3 class="font-semibold mt-4 mb-2 bg-voley-blue text-white p-2 rounded-md">2. Métricas Físicas</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="peso" class="block text-sm font-medium text-gray-700">Peso (kg)</label>
                                <input type="number" id="peso" step="0.1" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="talla" class="block text-sm font-medium text-gray-700">Talla (m)</label>
                                <input type="number" id="talla" step="0.01" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                        </div>

                        <h3 class="font-semibold mt-4 mb-2 bg-voley-blue text-white p-2 rounded-md">3. Datos de Nómina</h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="montoPago" class="block text-sm font-medium text-gray-700">Monto de Pago ($)</label>
                                <input type="number" id="montoPago" step="0.01" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="frecuenciaPago" class="block text-sm font-medium text-gray-700">Frecuencia de Pago</label>
                                <select id="frecuenciaPago" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                                    <option value="mensual">Mensual</option>
                                    <option value="quincenal">Quincenal</option>
                                    <option value="semanal">Semanal</option>
                                    <option value="unico">Pago Único</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label for="ultimaFechaPago" class="block text-sm font-medium text-gray-700">Última Fecha de Pago (Opcional)</label>
                                <input type="date" id="ultimaFechaPago" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                            </div>
                        </div>
                        
                        <p id="saveMessage" class="mt-4 text-sm font-medium text-center hidden"></p>

                        <button type="submit" id="saveButton" class="w-full mt-3 py-3 bg-voley-blue text-white font-semibold rounded-lg hover:bg-voley-dark transition duration-200" disabled>
                            <span id="saveButtonText">Cargando Autenticación...</span>
                        </button>
                    </form>
                </section>
            </div>

        </div>
    </main>

    <script type="module">
        // 1. FIREBASE IMPORTS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, getDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Asumiendo que firebase-config.js existe y exporta la configuración
        import { firebaseConfig } from './firebase-config.js'; 

        // 2. INITIALIZATION
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "control-voley"; 

        // Variables de estado
        let userId = null; // El UID del usuario logueado
        let isSaving = false;
        
        // Referencias de UI
        const tableBody = document.getElementById('athletesTableBody');
        const loadingMessage = document.getElementById('loadingMessage');
        const athleteForm = document.getElementById('athleteForm');
        const saveButton = document.getElementById('saveButton');
        const saveButtonText = document.getElementById('saveButtonText');

        // --- FUNCIONES CORE DE RUTA Y AUTENTICACIÓN ---

        /**
         * 1. Define la ruta de la colección de atletas específica para el usuario logueado.
         * Ruta: artifacts/{appId}/users/{userId}/athletes
         */
        const getAthletesCollectionRef = () => {
            if (!userId) {
                // Esto no debería pasar si onAuthStateChanged funciona bien, pero es seguro
                throw new Error("Error: Usuario no autenticado para obtener la colección.");
            }
            return collection(db, `artifacts/${appId}/users/${userId}/athletes`);
        };

        /**
         * 2. Maneja el estado de Autenticación al cargar la página.
         * Esto establece el 'userId' y comienza la carga de datos.
         */
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid; 
                console.log("Autenticación exitosa. UID:", userId);
                saveButton.disabled = false;
                saveButtonText.textContent = 'Guardar Atleta y Nómina';
                loadAthletes(); 
            } else {
                userId = null;
                console.warn("Usuario no autenticado. Redirigir al Login.");
                saveButtonText.textContent = 'Requiere Login';
                // Opcional: Redirigir si no hay sesión
                // window.location.href = 'index_login.html'; 
            }
        });

        // --- FUNCIONES DE UTILIDAD (NO MODIFICADAS, SOLO REFERENCIA) ---

        /**
         * Calcula la edad a partir de la fecha de nacimiento.
         */
        const calculateAge = (dob) => {
            if (!dob) return 'N/A';
            const diff = Date.now() - new Date(dob).getTime();
            const ageDate = new Date(diff); 
            return Math.abs(ageDate.getUTCFullYear() - 1970);
        };

        /**
         * Calcula el Índice de Masa Corporal (IMC).
         */
        const calculateIMC = (weight, height) => {
            if (weight > 0 && height > 0) {
                return (weight / (height * height)).toFixed(2);
            }
            return 'N/A';
        };

        // --- FUNCIONES DE NAVEGACIÓN Y VISTAS ---

        /**
         * Muestra la vista de tabla o la vista de formulario.
         */
        window.navigateTo = (view) => {
            document.getElementById('table-view').classList.add('hidden');
            document.getElementById('form-edit-view').classList.add('hidden');
            document.getElementById(`${view}-view`).classList.remove('hidden');

            if (view === 'table') {
                resetForm();
            }
        };

        /**
         * Resetea el formulario de atleta al modo 'Registro'.
         */
        const resetForm = () => {
            athleteForm.reset();
            document.getElementById('athleteId').value = ''; 
            document.getElementById('formTitle').textContent = 'Registro de Nuevo Atleta';
            saveButtonText.textContent = 'Guardar Atleta y Nómina';
            document.getElementById('saveMessage').classList.add('hidden');
        };

        // --- FUNCIONES CRUD ---

        /**
         * 3. LEE los datos de atletas del club logueado en tiempo real.
         */
        window.loadAthletes = function() {
            if (!db || !userId) return;

            try {
                const athletesCollectionRef = getAthletesCollectionRef(); 
                let q = query(athletesCollectionRef, orderBy('nombre', 'asc')); 

                // onSnapshot es la escucha en tiempo real
                onSnapshot(q, (snapshot) => {
                    const athletes = [];
                    snapshot.forEach(doc => {
                        athletes.push({ id: doc.id, ...doc.data() });
                    });
                    renderAthletesTable(athletes);
                });

            } catch (error) {
                console.error("Error al cargar atletas:", error);
                loadingMessage.textContent = "Error al cargar los datos. Revise la consola.";
            }
        };

        /**
         * 4. Dibuja las filas de la tabla con los datos de Firestore.
         * Incluye los botones Editar y Eliminar con el ID del documento.
         */
        const renderAthletesTable = (athletes) => {
            tableBody.innerHTML = ''; 
            loadingMessage.classList.add('hidden');

            if (athletes.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500">No hay atletas registrados para este club.</td></tr>`;
                return;
            }

            athletes.forEach(athlete => {
                const age = calculateAge(athlete.fechaNacimiento);
                const imc = calculateIMC(athlete.peso, athlete.talla);
                
                // Lógica de estado de pago (simplificada)
                const paymentStatus = { status: 'Al día', class: 'bg-green-100 text-green-800' }; // Lógica real debe ir aquí
                const imcStatusClass = imc > 25 ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'; 
                const salaryFormatted = new Intl.NumberFormat('es-VE', { style: 'currency', currency: 'USD' }).format(athlete.montoPago);
                const lastPayment = athlete.ultimaFechaPago || 'N/A';

                const row = `
                    <tr class="hover:bg-gray-100">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${athlete.nombre} ${athlete.apellido}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${age} años</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${imcStatusClass}">
                                IMC: ${imc}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${salaryFormatted}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${lastPayment}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                             <span class="px-2 inline-flex text-xs leading-5 rounded-full ${paymentStatus.class}">
                                ${paymentStatus.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex space-x-2">
                            <button onclick="editAthlete('${athlete.id}')" class="text-indigo-600 hover:text-indigo-900 transition font-bold">Editar</button>
                            <button onclick="confirmDelete('${athlete.id}', '${athlete.nombre} ${athlete.apellido}')" class="text-red-600 hover:text-red-800 transition">Eliminar</button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        };

        /**
         * 5. Controlador principal del formulario: Decide si es REGISTRO o ACTUALIZACIÓN.
         */
        window.handleFormSubmit = function(event) {
            event.preventDefault();
            const id = document.getElementById('athleteId').value;

            if (id) {
                updateAthlete(event, id); 
            } else {
                saveNewAthlete(event); 
            }
        };

        /**
         * 6. CREA un NUEVO atleta en Firestore.
         */
        window.saveNewAthlete = async function(event) {
            event.preventDefault();
            
            if (isSaving || !db || !userId) return;

            const saveMessage = document.getElementById('saveMessage');
            saveMessage.classList.add('hidden');
            saveButton.disabled = true; 
            saveButtonText.textContent = 'Guardando...';
            isSaving = true;

            try {
                const collectionRef = getAthletesCollectionRef(); 
                
                const newAthlete = {
                    nombre: document.getElementById('nombre').value.trim(),
                    apellido: document.getElementById('apellido').value.trim(),
                    fechaNacimiento: document.getElementById('fechaNacimiento').value,
                    telefono: document.getElementById('telefono').value.trim(),
                    peso: parseFloat(document.getElementById('peso').value),
                    talla: parseFloat(document.getElementById('talla').value),
                    montoPago: parseFloat(document.getElementById('montoPago').value), 
                    frecuenciaPago: document.getElementById('frecuenciaPago').value,
                    ultimaFechaPago: document.getElementById('ultimaFechaPago').value || 'N/A',
                };
                
                await addDoc(collectionRef, newAthlete);

                saveMessage.textContent = 'Atleta registrado con éxito. Regresando a la nómina...';
                saveMessage.classList.remove('hidden');
                saveMessage.style.color = 'green';
                
                setTimeout(() => {
                    navigateTo('table');
                }, 1000); 

            } catch (error) {
                console.error("Error al registrar el atleta:", error);
                saveMessage.textContent = `Error al registrar: ${error.message}. Revise la consola.`;
                saveMessage.classList.remove('hidden');
                saveMessage.style.color = 'red';
            } finally {
                saveButtonText.textContent = 'Guardar Atleta y Nómina';
                isSaving = false;
                saveButton.disabled = false;
            }
        };

        /**
         * 7. CARGA los datos de un atleta existente en el formulario.
         */
        window.editAthlete = async function(athleteId) {
            if (!db || !userId) return;
            
            try {
                const athletesCollectionRef = getAthletesCollectionRef();
                const docRef = doc(athletesCollectionRef, athleteId); 
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Cargar datos en el formulario
                    document.getElementById('athleteId').value = athleteId; 
                    document.getElementById('nombre').value = data.nombre;
                    document.getElementById('apellido').value = data.apellido;
                    document.getElementById('fechaNacimiento').value = data.fechaNacimiento;
                    document.getElementById('telefono').value = data.telefono;
                    document.getElementById('peso').value = data.peso;
                    document.getElementById('talla').value = data.talla;
                    document.getElementById('montoPago').value = data.montoPago;
                    document.getElementById('frecuenciaPago').value = data.frecuenciaPago;
                    document.getElementById('ultimaFechaPago').value = data.ultimaFechaPago === 'N/A' ? '' : data.ultimaFechaPago;

                    // Actualizar UI a modo Edición
                    document.getElementById('formTitle').textContent = `Editar Atleta: ${data.nombre} ${data.apellido}`;
                    document.getElementById('saveButtonText').textContent = 'Actualizar Datos';
                    document.getElementById('saveMessage').classList.add('hidden');
                    saveButton.disabled = false; // Asegurar que el botón esté activo
                    
                    navigateTo('form'); 
                    
                } else {
                    alert("Error: El atleta seleccionado no se encontró.");
                }
            } catch (error) {
                console.error("Error al cargar el documento para edición:", error);
                alert(`Fallo al cargar datos: ${error.message}`);
            }
        };

        /**
         * 8. ACTUALIZA un atleta existente en Firestore.
         */
        window.updateAthlete = async function(event, athleteId) {
            event.preventDefault();
            
            if (isSaving || !db || !userId) return;

            const saveMessage = document.getElementById('saveMessage');
            saveButton.disabled = true; 
            saveButtonText.textContent = 'Actualizando...';
            isSaving = true;

            try {
                const updatedData = {
                    nombre: document.getElementById('nombre').value.trim(),
                    apellido: document.getElementById('apellido').value.trim(),
                    fechaNacimiento: document.getElementById('fechaNacimiento').value,
                    telefono: document.getElementById('telefono').value.trim(),
                    peso: parseFloat(document.getElementById('peso').value),
                    talla: parseFloat(document.getElementById('talla').value),
                    montoPago: parseFloat(document.getElementById('montoPago').value), 
                    frecuenciaPago: document.getElementById('frecuenciaPago').value,
                    ultimaFechaPago: document.getElementById('ultimaFechaPago').value || 'N/A',
                };

                const athletesCollectionRef = getAthletesCollectionRef();
                const docRef = doc(athletesCollectionRef, athleteId);

                await updateDoc(docRef, updatedData);

                saveMessage.textContent = `Atleta actualizado con éxito. Regresando a la tabla...`;
                saveMessage.classList.remove('hidden');
                saveMessage.style.color = 'green';
                
                setTimeout(() => {
                    navigateTo('table');
                }, 1000); 

            } catch (error) {
                console.error("Error al actualizar el atleta en Firestore:", error);
                saveMessage.textContent = `Error al actualizar: ${error.message}.`;
                saveMessage.classList.remove('hidden');
                saveMessage.style.color = 'red';
            } finally {
                saveButtonText.textContent = 'Actualizar Datos';
                isSaving = false;
                saveButton.disabled = false;
            }
        };

        /**
         * 9. Elimina un atleta (función de confirmación).
         */
        window.confirmDelete = function(athleteId, athleteName) {
            if (confirm(`¿Estás seguro de que quieres eliminar al atleta ${athleteName}? Esta acción es permanente.`)) {
                deleteAthlete(athleteId, athleteName);
            }
        };

        /**
         * 10. ELIMINA un atleta de Firestore.
         */
        window.deleteAthlete = async function(athleteId, athleteName) {
            if (!db || !userId) return;
            
            try {
                const athletesCollectionRef = getAthletesCollectionRef();
                const docRef = doc(athletesCollectionRef, athleteId);
                
                await deleteDoc(docRef);
                alert(`✅ Atleta ${athleteName} eliminado con éxito.`);
            } catch (error) {
                console.error("Error al eliminar el atleta:", error);
                alert(`❌ Fallo al eliminar a ${athleteName}: ${error.message}`);
            }
        };

    </script>

</body>
</html>

